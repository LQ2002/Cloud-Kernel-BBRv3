name: Build Debian Kernel (x86_64) - Stable

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "Kernel version"
        required: true
        default: "6.12.37"
        type: string
      skip_cache:
        description: "Skip cache"
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    name: Prepare Build Parameters
    runs-on: ubuntu-24.04
    outputs:
      KERNEL_VERSION: ${{ steps.get_params.outputs.KERNEL_VERSION }}
      KERNEL_MAJOR: ${{ steps.get_params.outputs.KERNEL_MAJOR }}
      KERNEL_MINOR: ${{ steps.get_params.outputs.KERNEL_MINOR }}
    steps:
      - name: Get Parameters
        id: get_params
        run: |
          KV="${{ inputs.kernel_version }}"
          KM=$(echo "$KV" | cut -d'.' -f1)
          KMI=$(echo "$KV" | cut -d'.' -f2)

          echo "KERNEL_VERSION=$KV" >> $GITHUB_OUTPUT
          echo "KERNEL_MAJOR=$KM" >> $GITHUB_OUTPUT
          echo "KERNEL_MINOR=$KMI" >> $GITHUB_OUTPUT

  build:
    name: Build Kernel
    runs-on: ubuntu-24.04
    needs: prepare

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git curl patch jq bc bison flex rsync \
            libssl-dev libelf-dev libudev-dev libpci-dev libcap-dev \
            libncurses-dev kmod cpio xz-utils lz4 zstd pahole \
            libpcre2-dev libdw-dev libunwind-dev liblzma-dev \
            libzstd-dev libbabeltrace-dev libnuma-dev fakeroot \
            debhelper dpkg-dev quilt openssl

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Kernel Source
        run: |
          KV="${{ needs.prepare.outputs.KERNEL_VERSION }}"
          KM="${{ needs.prepare.outputs.KERNEL_MAJOR }}"

          wget https://cdn.kernel.org/pub/linux/kernel/v${KM}.x/linux-${KV}.tar.xz
          tar -xf linux-${KV}.tar.xz
          mv linux-${KV} linux
          rm linux-${KV}.tar.xz

      # -------------------------------
      # Download Xanmod + Bore patches
      # -------------------------------

      - name: Download Xanmod patches
        run: |
          KM="${{ needs.prepare.outputs.KERNEL_MAJOR }}"
          KMI="${{ needs.prepare.outputs.KERNEL_MINOR }}"

          echo "=== Xanmod: downloading patches ==="
          git clone --depth=1 https://gitlab.com/xanmod/linux-patches.git xanmod

          TARGET="linux-${KM}.${KMI}.y-xanmod"
          if [ ! -d "xanmod/${TARGET}" ]; then
            echo "Xanmod patches for ${KM}.${KMI} missing"
            echo "Trying fallback: highest version in repo"
            TARGET=$(ls xanmod | grep 'linux-' | sort -V | tail -1)
          fi

          echo "Using Xanmod patch dir: $TARGET"
          echo "XANMOD_DIR=xanmod/${TARGET}" >> $GITHUB_ENV

      - name: Download Bore patches
        run: |
          KM="${{ needs.prepare.outputs.KERNEL_MAJOR }}"
          KMI="${{ needs.prepare.outputs.KERNEL_MINOR }}"

          echo "=== Bore: downloading patches ==="
          git clone --depth=1 https://github.com/firelzrd/bore-scheduler.git bore

          cd bore/patches/stable

          # Find dirs matching major.minor
          MATCHES=($(ls -1d linux-${KM}.${KMI}* 2>/dev/null))

          if [ ${#MATCHES[@]} -eq 0 ]; then
            echo "No exact Bore match, using closest version"
            MATCH=$(ls -1d linux-* | sort -V | tail -1)
          else
            MATCH=$(printf "%s\n" "${MATCHES[@]}" | sort -V | tail -1)
          fi

          echo "Using Bore patch dir: $MATCH"
          echo "BORE_DIR=bore/patches/stable/${MATCH}" >> $GITHUB_ENV
          cd ../../..
            # ---------------------------------------------------
      # Apply Xanmod Patches
      # ---------------------------------------------------
      - name: Apply Xanmod Network Patches
        run: |
          cd linux
          XDIR="../${XANMOD_DIR}"

          echo "=== Applying Xanmod patches ==="
          ls -l "$XDIR"

          APPLIED=0
          SKIPPED=0

          for p in "$XDIR"/*.patch; do
            [ -f "$p" ] || continue
            echo "Testing $p"

            if patch -p1 --dry-run < "$p" >/dev/null 2>&1; then
              patch -p1 < "$p"
              APPLIED=$((APPLIED+1))
            else
              echo "Skipped due to conflicts: $(basename $p)"
              SKIPPED=$((SKIPPED+1))
            fi
          done

          echo "Xanmod applied: $APPLIED, skipped: $SKIPPED"
          if [ $APPLIED -eq 0 ]; then
            echo "Warning: No Xanmod patches applied"
          fi

      # ---------------------------------------------------
      # Apply Bore Patches
      # ---------------------------------------------------
      - name: Apply Bore Scheduler Patches
        run: |
          cd linux
          BDIR="../${BORE_DIR}"

          echo "=== Applying Bore patches ==="
          ls -l "$BDIR"

          APPLIED=0
          FAILED=0

          for p in "$BDIR"/*.patch; do
            echo "Trying patch $(basename $p)"

            if patch -p1 --dry-run < "$p" >/dev/null 2>&1; then
              echo "Clean apply"
              patch -p1 < "$p"
              APPLIED=$((APPLIED+1))
            else
              echo "Try fuzzy apply"
              if patch -p1 --fuzz=3 < "$p" >/dev/null 2>&1; then
                echo "Applied with fuzz"
                APPLIED=$((APPLIED+1))
              else
                echo "Failed: $(basename $p)"
                FAILED=$((FAILED+1))
              fi
            fi
          done

          echo "BORE applied=$APPLIED failed=$FAILED"
          if [ $APPLIED -eq 0 ]; then
            echo "Warning: No Bore patches applied"
          fi

      # ---------------------------------------------------
      # Integrate LotSpeed (Zeta-TCP)
      # ---------------------------------------------------
      - name: Integrate LotSpeed (Zeta-TCP)
        run: |
          cd linux

          echo "=== Integrating LotSpeed ==="
          git clone -b zeta-tcp --depth=1 https://github.com/uk0/lotspeed.git ../lotspeed

          cp ../lotspeed/lotspeed.c net/ipv4/tcp_lotspeed.c
          echo "obj-\$(CONFIG_TCP_CONG_LOTSPEED) += tcp_lotspeed.o" >> net/ipv4/Makefile

          cat >> net/ipv4/Kconfig <<'EOF'

          config TCP_CONG_LOTSPEED
              tristate "LotSpeed Zeta-TCP congestion control"
              default y
              help
                Experimental congestion control algorithm for high-latency networks.
          EOF

      # ---------------------------------------------------
      # Configure Kernel
      # ---------------------------------------------------
      - name: Configure Kernel
        run: |
          cd linux

          if [ -f "../configs/x86_64.config" ]; then
            cp ../configs/x86_64.config .config
          else
            make defconfig
          fi

          echo "=== Enabling BORE Scheduler ==="
          scripts/config --enable CONFIG_SCHED_CLASS_EXT
          scripts/config --enable CONFIG_SCHED_BORE

          echo "=== Enable Congestion Control ==="
          scripts/config --set-val CONFIG_TCP_CONG_ADVANCED y
          scripts/config --set-val CONFIG_TCP_CONG_BBR y
          scripts/config --set-val CONFIG_TCP_CONG_BBR1 y 2>/dev/null || true
          scripts/config --set-val CONFIG_TCP_CONG_BBRPLUS y 2>/dev/null || true
          scripts/config --set-val CONFIG_TCP_CONG_BRUTAL y 2>/dev/null || true
          scripts/config --set-val CONFIG_TCP_CONG_LOTSPEED y

          scripts/config --set-val CONFIG_TCP_CONG_CUBIC y
          scripts/config --set-val CONFIG_TCP_CONG_RENO y
          scripts/config --set-val CONFIG_TCP_CONG_HTCP y
          scripts/config --set-val CONFIG_TCP_CONG_WESTWOOD y
          scripts/config --set-val CONFIG_TCP_CONG_VEGAS y

          scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
          scripts/config --enable CONFIG_DEFAULT_BBR
          scripts/config --disable CONFIG_DEFAULT_CUBIC

          echo "=== Disable BTF ==="
          scripts/config --disable CONFIG_DEBUG_INFO_BTF
          scripts/config --disable CONFIG_DEBUG_INFO_BTF_MODULES
          scripts/config --disable CONFIG_DEBUG_INFO
          scripts/config --disable CONFIG_INFINIBAND
          scripts/config --disable CONFIG_RDMA

          make olddefconfig

      # ---------------------------------------------------
      # Build Kernel
      # ---------------------------------------------------
      - name: Build Kernel Debian Packages
        env:
          KBUILD_BUILD_USER: "github"
          KBUILD_BUILD_HOST: "actions"
          KDEB_COMPRESS: "xz"
        run: |
          cd linux
          make -j$(nproc) bindeb-pkg

      # ---------------------------------------------------
      # Upload Artifacts
      # ---------------------------------------------------
      - name: Upload Kernel .deb Files
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ needs.prepare.outputs.KERNEL_VERSION }}
          path: |
            *.deb
            *.buildinfo
            *.changes
            linux/.config

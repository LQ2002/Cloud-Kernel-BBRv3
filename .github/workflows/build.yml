name: Build Debian Kernel (x86_64)

on:
  repository_dispatch:
    types: [trigger-x86_64-build]
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "Kernel version"
        required: true
        default: "6.12.37"
        type: string
      skip_cache:
        description: "Skip Cache"
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    name: Prepare Build Parameters
    runs-on: ubuntu-24.04
    outputs:
      kernel_version: ${{ steps.prepare_build_parameters.outputs.KERNEL_VERSION }}
      kernel_minor_version: ${{ steps.prepare_build_parameters.outputs.KERNEL_MINOR_VERSION }}
      kernel_major_version: ${{ steps.prepare_build_parameters.outputs.KERNEL_MAJOR_VERSION }}
      skip_cache: ${{ steps.prepare_build_parameters.outputs.SKIP_CACHE }}
    steps:
      - name: Prepare Build Parameters
        id: prepare_build_parameters
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            KERNEL_VERSION="${{ github.event.client_payload.kernel_version }}"
          else
            KERNEL_VERSION="${{ inputs.kernel_version }}"
          fi
          KERNEL_MINOR_VERSION=$(echo "$KERNEL_VERSION" | cut -d '.' -f 2)
          KERNEL_MAJOR_VERSION=$(echo "$KERNEL_VERSION" | cut -d '.' -f 1)
          SKIP_CACHE="${{ inputs.skip_cache }}" || SKIP_CACHE=false

          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          echo "KERNEL_MINOR_VERSION=$KERNEL_MINOR_VERSION" >> $GITHUB_OUTPUT
          echo "KERNEL_MAJOR_VERSION=$KERNEL_MAJOR_VERSION" >> $GITHUB_OUTPUT
          echo "SKIP_CACHE=$SKIP_CACHE" >> $GITHUB_OUTPUT

  build:
    name: Build Debian Kernel Package for x86_64
    runs-on: ubuntu-24.04
    needs: prepare
    outputs:
      kernel_version: ${{ needs.prepare.outputs.kernel_version }}
      build_time: ${{ steps.get_build_time.outputs.BUILD_TIMESTAMP }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl git patch jq openssl quilt \
            libncurses-dev libssl-dev libelf-dev libudev-dev libpci-dev libcap-dev libpcre2-dev libcurl4-openssl-dev \
            bison bc flex rsync debhelper lz4 pahole zstd dpkg-dev fakeroot kmod cpio xz-utils ccache \
            libdw-dev binutils-dev libunwind-dev libslang2-dev python3-dev python3-setuptools \
            liblzma-dev libzstd-dev libbabeltrace-dev libbfd-dev libiberty-dev libnuma-dev perl

      - name: Checkout Kernel Sources
        uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Download Linux Kernel Source
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ needs.prepare.outputs.kernel_version }}.tar.xz
          tar -xf linux-${{ needs.prepare.outputs.kernel_version }}.tar.xz
          rm linux-${{ needs.prepare.outputs.kernel_version }}.tar.xz
          mv linux-${{ needs.prepare.outputs.kernel_version }} linux

      - name: Download and Check Patches
        run: |
          echo "=== Downloading patches for kernel ${{ needs.prepare.outputs.kernel_version }} ==="
          echo ""
          
          # Debian 补丁
          echo "Downloading Debian kernel patches..."
          if git clone -b debian/${{ needs.prepare.outputs.kernel_version }}-1 --depth=1 https://salsa.debian.org/kernel-team/linux.git linux-debian 2>&1; then
            echo "✅ Debian patches downloaded successfully"
            echo "DEBIAN_OK=true" >> $GITHUB_ENV
          else
            echo "⚠️ Debian patches not available (this is normal for newer kernels)"
            echo "DEBIAN_OK=false" >> $GITHUB_ENV
          fi
          
          echo ""
          
          # Xanmod 补丁
          echo "Downloading Xanmod network patches..."
          if git clone --depth=1 https://gitlab.com/xanmod/linux-patches.git linux-xanmod-patches 2>&1; then
            XANMOD_DIR="linux-xanmod-patches/linux-${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}.y-xanmod"
            if [ -d "$XANMOD_DIR" ]; then
              echo "✅ Xanmod patches downloaded successfully"
              echo "XANMOD_OK=true" >> $GITHUB_ENV
            else
              echo "⚠️ Xanmod patches not available for kernel ${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}"
              echo "Available versions:"
              ls linux-xanmod-patches/ | grep "linux-" | sort -V
              echo "XANMOD_OK=false" >> $GITHUB_ENV
            fi
          else
            echo "❌ Failed to download Xanmod patches repository"
            echo "XANMOD_OK=false" >> $GITHUB_ENV
          fi
          
          echo ""
          
          # Bore 补丁
          echo "Downloading Bore scheduler patches..."
          if git clone --depth=1 https://github.com/firelzrd/bore-scheduler.git bore-patches 2>&1; then
            BORE_DIR="bore-patches/patches/stable/linux-${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}-bore"
            if [ -d "$BORE_DIR" ]; then
              echo "✅ Bore patches downloaded successfully"
              echo "BORE_OK=true" >> $GITHUB_ENV
            else
              echo "⚠️ Bore patches not available for kernel ${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}"
              echo "Available versions:"
              ls bore-patches/patches/stable/ | grep "linux-" | sort -V
              echo "BORE_OK=false" >> $GITHUB_ENV
            fi
          else
            echo "❌ Failed to download Bore patches repository"
            echo "BORE_OK=false" >> $GITHUB_ENV
          fi
          
          echo ""
          
          # Lotspeed (Zeta-TCP) 补丁
          echo "Downloading Lotspeed (Zeta-TCP) congestion control patches..."
          if git clone --depth=1 -b zeta-tcp https://github.com/uk0/lotspeed.git lotspeed-patches 2>&1; then
            if [ -d "lotspeed-patches" ]; then
              echo "✅ Lotspeed patches downloaded successfully"
              echo "LOTSPEED_OK=true" >> $GITHUB_ENV
              
              # 列出可用的补丁文件
              echo "Available Lotspeed patches:"
              find lotspeed-patches -name "*.patch" -o -name "*.diff" | head -20
            else
              echo "⚠️ Lotspeed repository downloaded but directory structure unexpected"
              echo "LOTSPEED_OK=false" >> $GITHUB_ENV
            fi
          else
            echo "❌ Failed to download Lotspeed patches repository"
            echo "LOTSPEED_OK=false" >> $GITHUB_ENV
          fi
          
          echo ""
          echo "=== Patch download summary ==="
          echo "Debian: $DEBIAN_OK"
          echo "Xanmod: $XANMOD_OK"
          echo "Bore: $BORE_OK"
          echo "Lotspeed: $LOTSPEED_OK"

      - name: Organize Patches
        run: |
          cd linux
          mkdir -p patches
          
          echo "=== Step 1: Copy Debian patches ==="
          if [ "$DEBIAN_OK" == "true" ] && [ -d "../linux-debian/debian/patches" ]; then
            cp -R ../linux-debian/debian/patches/* ./patches/
            echo "✅ Debian patches copied"
          else
            touch patches/series
            echo "⚠️ Debian patches not available, creating empty series"
          fi
          
          echo ""
          echo "=== Step 2: Copy Xanmod patches ==="
          if [ "$XANMOD_OK" == "true" ]; then
            XANMOD_SOURCE="../linux-xanmod-patches/linux-${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}.y-xanmod"
            
            if [ -d "$XANMOD_SOURCE/net" ]; then
              mkdir -p patches/xanmod-net
              cp -R "$XANMOD_SOURCE/net"/* patches/xanmod-net/
              
              XANMOD_COUNT=$(find patches/xanmod-net -type f -name "*.patch" | wc -l)
              echo "✅ Copied $XANMOD_COUNT Xanmod patches"
            else
              echo "⚠️ Xanmod net directory not found"
            fi
          else
            echo "⚠️ Xanmod patches not available, skipping"
          fi
          
          echo ""
          echo "=== Step 3: Copy Bore patches ==="
          if [ "$BORE_OK" == "true" ]; then
            BORE_SOURCE="../bore-patches/patches/stable/linux-${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}-bore"
            
            if [ -d "$BORE_SOURCE" ]; then
              cp -R "$BORE_SOURCE" patches/cpu-scheduler
              
              BORE_COUNT=$(find patches/cpu-scheduler -type f -name "*.patch" | wc -l)
              echo "✅ Copied $BORE_COUNT Bore patches"
            else
              echo "⚠️ Bore directory not found"
            fi
          else
            echo "⚠️ Bore patches not available, skipping"
          fi
          
          echo ""
          echo "=== Step 4: Integrate Lotspeed (Zeta-TCP) source code ==="
          if [ "$LOTSPEED_OK" == "true" ]; then
            echo "Lotspeed is a kernel module, integrating source into kernel tree..."
            
            # 创建目标目录
            mkdir -p net/ipv4/lotspeed
            
            # 复制主要源文件
            if [ -f "../lotspeed-patches/lotspeed.c" ]; then
              cp ../lotspeed-patches/lotspeed.c net/ipv4/lotspeed/
              echo "✅ Copied lotspeed.c"
            fi
            
            # 创建 Makefile
            cat > net/ipv4/lotspeed/Makefile << 'EOF'
# SPDX-License-Identifier: GPL-2.0
obj-$(CONFIG_TCP_CONG_LOTSPEED) += tcp_lotspeed.o
tcp_lotspeed-y := lotspeed.o
EOF
            echo "✅ Created Makefile for Lotspeed"
            
            # 创建 Kconfig
            cat > net/ipv4/lotspeed/Kconfig << 'EOF'
# SPDX-License-Identifier: GPL-2.0-only
config TCP_CONG_LOTSPEED
	tristate "Lotspeed (Zeta-TCP) TCP congestion control"
	default m
	help
	  Lotspeed is a high-performance TCP congestion control algorithm
	  based on Zeta-TCP. It combines delay-based and loss-based approaches
	  for optimal throughput and low latency.

	  See https://github.com/uk0/lotspeed for more details.

	  To compile this as a module, choose M here: the module
	  will be called tcp_lotspeed.
EOF
            echo "✅ Created Kconfig for Lotspeed"
            
            # 修改 net/ipv4/Makefile 添加 lotspeed 子目录
            if ! grep -q "obj-y += lotspeed/" net/ipv4/Makefile; then
              echo "obj-y += lotspeed/" >> net/ipv4/Makefile
              echo "✅ Added Lotspeed to net/ipv4/Makefile"
            fi
            
            # 修改 net/ipv4/Kconfig 添加 lotspeed 配置
            if ! grep -q "source \"net/ipv4/lotspeed/Kconfig\"" net/ipv4/Kconfig; then
              # 在 TCP congestion control 部分后添加
              sed -i '/menu "TCP: advanced congestion control"/a source "net/ipv4/lotspeed/Kconfig"' net/ipv4/Kconfig || \
              sed -i '/config TCP_CONG_ADVANCED/a source "net/ipv4/lotspeed/Kconfig"' net/ipv4/Kconfig || \
              echo 'source "net/ipv4/lotspeed/Kconfig"' >> net/ipv4/Kconfig
              echo "✅ Added Lotspeed to net/ipv4/Kconfig"
            fi
            
            echo "✅ Lotspeed source code integrated into kernel tree"
            echo "LOTSPEED_INTEGRATED=true" >> $GITHUB_ENV
          else
            echo "⚠️ Lotspeed source not available, skipping"
            echo "LOTSPEED_INTEGRATED=false" >> $GITHUB_ENV
          fi
          
          echo ""
          echo "=== Step 5: Copy custom patches ==="
          CUSTOM_SOURCE="../kernel_patches/${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}"
          
          echo "Looking for custom patches in: $CUSTOM_SOURCE"
          
          if [ -d "$CUSTOM_SOURCE" ]; then
            echo "✅ Custom patch directory found"
            
            mkdir -p patches/custom
            cp -R "$CUSTOM_SOURCE"/* patches/custom/
            
            echo "Copied custom patches:"
            find patches/custom -type f -name "*.patch" | while read f; do
              echo "  - $f"
            done
            
            CUSTOM_COUNT=$(find patches/custom -type f -name "*.patch" | wc -l)
            echo "✅ Total custom patches: $CUSTOM_COUNT"
          else
            echo "⚠️ Custom patch directory not found: $CUSTOM_SOURCE"
          fi
          
          echo ""
          echo "=== Step 6: Build series file ==="
          cd patches
          
          if [ "$DEBIAN_OK" != "true" ]; then
            echo "# Patch series for kernel ${{ needs.prepare.outputs.kernel_version }}" > series
            echo "# Generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> series
          fi
          
          if [ -d "./xanmod-net" ]; then
            XANMOD_PATCH_COUNT=$(find ./xanmod-net -type f -name "*.patch" | wc -l)
            if [ $XANMOD_PATCH_COUNT -gt 0 ]; then
              echo "" >> series
              echo "# Xanmod Network Patches ($XANMOD_PATCH_COUNT patches)" >> series
              find ./xanmod-net -type f -name "*.patch" -printf "xanmod-net/%P\n" | sort >> series
              echo "Added $XANMOD_PATCH_COUNT Xanmod patches to series"
            fi
          fi
          
          if [ -d "./cpu-scheduler" ]; then
            BORE_PATCH_COUNT=$(find ./cpu-scheduler -type f -name "*.patch" | wc -l)
            if [ $BORE_PATCH_COUNT -gt 0 ]; then
              echo "" >> series
              echo "# Bore CPU Scheduler Patches ($BORE_PATCH_COUNT patches)" >> series
              find ./cpu-scheduler -type f -name "*.patch" -printf "cpu-scheduler/%P\n" | sort >> series
              echo "Added $BORE_PATCH_COUNT Bore patches to series"
            fi
          fi
          
          if [ -d "./lotspeed" ]; then
            LOTSPEED_PATCH_COUNT=$(find ./lotspeed -type f \( -name "*.patch" -o -name "*.diff" \) | wc -l)
            
            if [ $LOTSPEED_PATCH_COUNT -gt 0 ]; then
              echo "" >> series
              echo "# Lotspeed (Zeta-TCP) Congestion Control Patches ($LOTSPEED_PATCH_COUNT patches)" >> series
              find ./lotspeed -type f \( -name "*.patch" -o -name "*.diff" \) -printf "lotspeed/%P\n" | sort >> series
              
              echo "✅ Added $LOTSPEED_PATCH_COUNT Lotspeed patches to series"
              
              echo ""
              echo "Lotspeed patches in series:"
              grep "^lotspeed/" series | nl
            else
              echo "⚠️ No Lotspeed patches (source code integration used instead)"
            fi
          fi
          
          if [ -d "./custom" ]; then
            CUSTOM_PATCH_COUNT=$(find ./custom -type f -name "*.patch" | wc -l)
            
            if [ $CUSTOM_PATCH_COUNT -gt 0 ]; then
              echo "" >> series
              echo "# Custom Patches ($CUSTOM_PATCH_COUNT patches)" >> series
              find ./custom -type f -name "*.patch" -printf "custom/%P\n" | sort >> series
              
              echo "✅ Added $CUSTOM_PATCH_COUNT custom patches to series"
              
              echo ""
              echo "Custom patches in series:"
              grep "^custom/" series | nl
            fi
          fi
          
          echo ""
          echo "=== Final series file content ==="
          cat series
          echo "=================================="
          
          echo ""
          echo "=== Statistics ==="
          TOTAL_PATCHES=$(grep -c "\.patch$\|\.diff$" series || echo 0)
          XANMOD_IN_SERIES=$(grep -c "^xanmod-net/" series || echo 0)
          BORE_IN_SERIES=$(grep -c "^cpu-scheduler/" series || echo 0)
          LOTSPEED_IN_SERIES=$(grep -c "^lotspeed/" series || echo 0)
          CUSTOM_IN_SERIES=$(grep -c "^custom/" series || echo 0)
          
          echo "Total patches in series: $TOTAL_PATCHES"
          echo "  - Xanmod: $XANMOD_IN_SERIES"
          echo "  - Bore: $BORE_IN_SERIES"
          echo "  - Lotspeed: $LOTSPEED_IN_SERIES"
          echo "  - Custom: $CUSTOM_IN_SERIES"
          echo "=================="

      - name: Apply Patches
        run: |
          cd linux
          
          if [ ! -s patches/series ]; then
            echo "⚠️ No patches to apply"
            exit 0
          fi
          
          echo "=== Applying Patches ==="
          quilt push -a -v || echo "Some patches may have failed"
          
          echo ""
          echo "=== Patch Summary ==="
          
          TOTAL_EXPECTED=$(grep -c "\.patch$\|\.diff$" patches/series || echo 0)
          TOTAL_APPLIED=$(quilt applied 2>/dev/null | wc -l || echo 0)
          
          echo "Total: $TOTAL_APPLIED / $TOTAL_EXPECTED applied"
          
          LOTSPEED_EXPECTED=$(grep -c "^lotspeed/" patches/series || echo 0)
          
          if [ $LOTSPEED_EXPECTED -gt 0 ]; then
            LOTSPEED_APPLIED=$(quilt applied 2>/dev/null | grep -c "^lotspeed/" || echo 0)
            
            echo "Lotspeed patches: $LOTSPEED_APPLIED / $LOTSPEED_EXPECTED"
            
            if [ $LOTSPEED_APPLIED -gt 0 ]; then
              echo "✅ Lotspeed patches applied:"
              quilt applied | grep "^lotspeed/"
            fi
          fi
          
          CUSTOM_EXPECTED=$(grep -c "^custom/" patches/series || echo 0)
          
          if [ $CUSTOM_EXPECTED -gt 0 ]; then
            CUSTOM_APPLIED=$(quilt applied 2>/dev/null | grep -c "^custom/" || echo 0)
            
            echo "Custom patches: $CUSTOM_APPLIED / $CUSTOM_EXPECTED"
            
            if [ $CUSTOM_APPLIED -gt 0 ]; then
              echo "✅ Custom patches applied:"
              quilt applied | grep "^custom/"
            fi
          fi
          
          echo ""
          echo "Final patch: $(quilt top)"

      - name: Configure Kernel
        run: |
          cd linux
          cp ../configs/x86_64.config .config
          
          echo "=== Configuring TCP Congestion Control ==="
          
          # 如果 Lotspeed 源代码已集成,启用相关配置
          if [ "$LOTSPEED_INTEGRATED" == "true" ]; then
            echo "Enabling Lotspeed congestion control..."
            
            # 启用高级拥塞控制选项
            scripts/config --enable CONFIG_TCP_CONG_ADVANCED
            
            # 启用 Lotspeed 拥塞控制算法(作为模块或内建)
            scripts/config --module CONFIG_TCP_CONG_LOTSPEED || \
            scripts/config --enable CONFIG_TCP_CONG_LOTSPEED || \
            echo "⚠️ CONFIG_TCP_CONG_LOTSPEED config failed, will check after olddefconfig"
            
            # 设置 Lotspeed 为默认拥塞控制算法
            scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "lotspeed"
            
            echo "✅ Lotspeed configured"
          fi
          
          if [ "$XANMOD_OK" == "true" ]; then
            echo "Configuring Xanmod BBR variants..."
            
            # 启用 BBR (CONFIG_TCP_CONG_BBR) 作为内建或模块
            scripts/config --enable CONFIG_TCP_CONG_BBR
            
            # 其他 BBR 变体作为内建或模块
            scripts/config --enable CONFIG_TCP_CONG_BBR1 || echo "⚠️ BBR1 not available"
            scripts/config --enable CONFIG_TCP_CONG_BBRPLUS || echo "⚠️ BBRPlus not available"
            scripts/config --enable CONFIG_TCP_CONG_BRUTAL || echo "⚠️ Brutal not available"
            
            # 如果没有启用 Lotspeed,则设置 BBR 为默认
            if [ "$LOTSPEED_OK" != "true" ]; then
              scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
              scripts/config --enable CONFIG_DEFAULT_BBR
              scripts/config --disable CONFIG_DEFAULT_CUBIC
              echo "✅ Configured BBR as default congestion control"
            else
              echo "✅ BBR variants enabled but Lotspeed will be used as default"
            fi
          else
            echo "⚠️ Xanmod patches not available, skipping BBR configuration"
          fi
          
          echo ""
          echo "=== Disabling BTF to prevent build failures ==="
          scripts/config --disable CONFIG_DEBUG_INFO_BTF
          scripts/config --disable CONFIG_DEBUG_INFO_BTF_MODULES
          scripts/config --disable CONFIG_DEBUG_INFO
          scripts/config --disable CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT
          
          make olddefconfig
          
          echo "=== Configuration complete ==="

      - name: Verify Kernel Configuration
        run: |
          cd linux
          
          echo "================================================"
          echo "Verifying Kernel Configuration"
          echo "================================================"
          
          echo ""
          echo "Checking BTF status (should be disabled):"
          if grep -q "# CONFIG_DEBUG_INFO_BTF is not set" .config; then
            echo "✅ BTF is disabled"
          else
            echo "⚠️ BTF might still be enabled"
            grep "CONFIG_DEBUG_INFO_BTF" .config || true
          fi
          
          if [ "$LOTSPEED_INTEGRATED" == "true" ]; then
            echo ""
            echo "Checking Lotspeed integration:"
            
            # 检查源文件是否存在
            if [ -f "net/ipv4/lotspeed/lotspeed.c" ]; then
              echo "✅ Lotspeed source file integrated: net/ipv4/lotspeed/lotspeed.c"
            else
              echo "❌ Lotspeed source file NOT found"
            fi
            
            # 检查配置
            echo ""
            echo "Lotspeed configuration status:"
            if grep -q "CONFIG_TCP_CONG_LOTSPEED=y\|CONFIG_TCP_CONG_LOTSPEED=m" .config; then
              echo "✅ Lotspeed is enabled"
              grep "CONFIG_TCP_CONG_LOTSPEED" .config | grep -v "^#"
            else
              echo "⚠️ Lotspeed not found in .config (checking all occurrences):"
              grep "CONFIG_TCP_CONG_LOTSPEED" .config || echo "  (no CONFIG_TCP_CONG_LOTSPEED entry at all)"
            fi
            
            echo ""
            echo "Default congestion control:"
            if grep -q 'CONFIG_DEFAULT_TCP_CONG="lotspeed"' .config; then
              echo "✅ Lotspeed is set as default"
            elif grep -q "CONFIG_DEFAULT_TCP_CONG" .config; then
              echo "Current default:"
              grep "CONFIG_DEFAULT_TCP_CONG" .config | grep -v "^#"
              echo "⚠️ Note: Lotspeed may not be available as default option if build fails"
            fi
          fi
          
          if [ "$XANMOD_OK" == "true" ]; then
            echo ""
            echo "Checking BBR variants configuration:"
            echo "BBR (will be bbrv3):"
            grep "CONFIG_TCP_CONG_BBR=" .config | grep -v "^#"
            
            echo ""
            echo "Other variants:"
            grep "CONFIG_TCP_CONG_BBR1\|CONFIG_TCP_CONG_BBRPLUS\|CONFIG_TCP_CONG_BRUTAL" .config | grep -v "^#" || echo "(not found)"
            
            echo ""
            echo "Default congestion control:"
            if grep -q 'CONFIG_DEFAULT_TCP_CONG="bbrv3"' .config; then
              echo "✅ BBRv3 is set as default"
            else
              echo "Current default:"
              grep "CONFIG_DEFAULT_TCP_CONG" .config | grep -v "^#"
            fi
          fi
          
          echo ""
          echo "All available TCP congestion control algorithms:"
          grep "CONFIG_TCP_CONG_" .config | grep -v "^#" | grep "=" || echo "None found"
          
          echo ""
          echo "================================================"

      - name: Build Kernel Debian Packages
        env:
          KBUILD_BUILD_USER: "cloudpassenger"
          KBUILD_BUILD_HOST: "github-actions"
          KDEB_COMPRESS: "xz"
        run: |
          cd linux
          make -j $(nproc) bindeb-pkg

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-x86_64-lotspeed
          path: |
            *.deb
            *.changes
            *.buildinfo
            *.config

      - name: Get build time
        id: get_build_time
        run: |
          BUILD_TIMESTAMP=$(date -Is)
          echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT

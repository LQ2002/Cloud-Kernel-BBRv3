name: Build Debian Kernel (x86_64) - Stable

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "Kernel version"
        required: true
        default: "6.12.21"
        type: string
      skip_cache:
        description: "Skip cache"
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    name: Prepare Build Parameters
    runs-on: ubuntu-24.04
    outputs:
      KERNEL_VERSION: ${{ steps.get_params.outputs.KERNEL_VERSION }}
      KERNEL_MAJOR: ${{ steps.get_params.outputs.KERNEL_MAJOR }}
      KERNEL_MINOR: ${{ steps.get_params.outputs.KERNEL_MINOR }}
    steps:
      - name: Get Parameters
        id: get_params
        run: |
          KV="${{ inputs.kernel_version }}"
          KM=$(echo "$KV" | cut -d'.' -f1)
          KMI=$(echo "$KV" | cut -d'.' -f2)

          echo "KERNEL_VERSION=$KV" >> $GITHUB_OUTPUT
          echo "KERNEL_MAJOR=$KM" >> $GITHUB_OUTPUT
          echo "KERNEL_MINOR=$KMI" >> $GITHUB_OUTPUT

  build:
    name: Build Kernel
    runs-on: ubuntu-24.04
    needs: prepare

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git curl patch jq bc bison flex rsync \
            libssl-dev libelf-dev libudev-dev libpci-dev libcap-dev \
            libncurses-dev kmod cpio xz-utils lz4 zstd pahole \
            libpcre2-dev libdw-dev libunwind-dev liblzma-dev \
            libzstd-dev libbabeltrace-dev libnuma-dev fakeroot \
            debhelper dpkg-dev quilt openssl

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Kernel Source
        run: |
          KV="${{ needs.prepare.outputs.KERNEL_VERSION }}"
          KM="${{ needs.prepare.outputs.KERNEL_MAJOR }}"

          wget https://cdn.kernel.org/pub/linux/kernel/v${KM}.x/linux-${KV}.tar.xz
          tar -xf linux-${KV}.tar.xz
          mv linux-${KV} linux
          rm linux-${KV}.tar.xz
      - name: Download Debian Kernel Additional Source
        run: |
          echo "⌛ Downloading Debian Kernel Additional Source..."
          git clone -b debian/${{ needs.prepare.outputs.KERNEL_VERSION }}-1 --depth=1 https://salsa.debian.org/kernel-team/linux.git linux-debian || echo "No matching debian branch, continuing"
          echo "✅ Downloaded Debian Kernel Additional Source (if available)"

      - name: Download Xanmod Patches (with fallback)
        run: |
          echo "⌛ Downloading Xanmod Patches..."
          git clone --depth=1 https://gitlab.com/xanmod/linux-patches.git linux-xanmod-patches
          TARGET_DIR="linux-${{ needs.prepare.outputs.KERNEL_MAJOR }}.${{ needs.prepare.outputs.KERNEL_MINOR }}.y-xanmod"
          if [ -d "linux-xanmod-patches/${TARGET_DIR}/net" ]; then
            echo "Using Xanmod net patches: ${TARGET_DIR}"
            echo "XANMOD_NET_DIR=linux-xanmod-patches/${TARGET_DIR}/net" >> $GITHUB_ENV
          else
            echo "Exact Xanmod net dir ${TARGET_DIR} not found, trying fallback to latest linux-*.y-xanmod"
            FALLBACK=$(ls -1 linux-xanmod-patches | grep '^linux-' | grep 'y-xanmod' | sort -V | tail -1)
            if [ -n "$FALLBACK" ] && [ -d "linux-xanmod-patches/${FALLBACK}/net" ]; then
              echo "Using fallback Xanmod net dir: $FALLBACK"
              echo "XANMOD_NET_DIR=linux-xanmod-patches/${FALLBACK}/net" >> $GITHUB_ENV
            else
              echo "No Xanmod net patches found; XANMOD_NET_DIR unset"
            fi
          fi
          echo "✅ Xanmod clone done"

      - name: Checkout Bore-Scheduler Patches
        uses: actions/checkout@v4
        with:
          repository: firelzrd/bore-scheduler
          path: bore-patches

      - name: Organize Patches (quilt series)
        run: |
          set -e
          echo "⌛ Organizing patches into linux/patches..."
          cd linux
          rm -rf patches
          mkdir -p patches

          # copy Debian patches if present
          if [ -d "../linux-debian/debian/patches" ]; then
            cp -R ../linux-debian/debian/patches/* patches/ || true
            echo "⭕ Copied Debian patches"
          else
            echo "No debian/patches found"
          fi

          # copy Xanmod net patches if available
          if [ -n "${XANMOD_NET_DIR:-}" ] && [ -d "../${XANMOD_NET_DIR}" ]; then
            mkdir -p patches/net
            cp -R ../${XANMOD_NET_DIR}/* patches/net/ || true
            echo "⭕ Copied Xanmod net patches from ${XANMOD_NET_DIR}"
          else
            echo "No Xanmod net patches to copy"
          fi

          # copy Bore patches (select closest / fallback)
          BORE_SRC="../bore-patches/patches/stable"
          if [ -d "$BORE_SRC" ]; then
            # try exact major.minor-bore name, else choose latest linux-*bore
            WANT="linux-${{ needs.prepare.outputs.KERNEL_MAJOR }}.${{ needs.prepare.outputs.KERNEL_MINOR }}-bore"
            if [ -d "${BORE_SRC}/${WANT}" ]; then
              mkdir -p patches/cpu-scheduler
              cp -R ${BORE_SRC}/${WANT}/* patches/cpu-scheduler/ || true
              echo "⭕ Copied Bore patches ${WANT}"
            else
              FALLBACK=$(ls -1 ${BORE_SRC} | grep '^linux-' | grep '-bore' | sort -V | tail -1)
              if [ -n "$FALLBACK" ]; then
                mkdir -p patches/cpu-scheduler
                cp -R ${BORE_SRC}/${FALLBACK}/* patches/cpu-scheduler/ || true
                echo "⭕ Copied Bore fallback patches ${FALLBACK}"
              else
                echo "No Bore patches found"
              fi
            fi
          fi

          # copy local custom kernel_patches if present (versioned by minor)
          LOCAL_CUSTOM="../kernel_patches/${{ needs.prepare.outputs.KERNEL_MAJOR }}.${{ needs.prepare.outputs.KERNEL_MINOR }}"
          if [ -d "$LOCAL_CUSTOM" ]; then
            mkdir -p patches/custom
            cp -R $LOCAL_CUSTOM/* patches/custom/ || true
            echo "⭕ Copied local custom patches from $LOCAL_CUSTOM"
          else
            # also accept kernel_patches/<minor> without major prefix if you use that layout
            LOCAL_CUSTOM2="../kernel_patches/${{ needs.prepare.outputs.KERNEL_MINOR }}"
            if [ -d "$LOCAL_CUSTOM2" ]; then
              mkdir -p patches/custom
              cp -R $LOCAL_CUSTOM2/* patches/custom/ || true
              echo "⭕ Copied local custom patches from $LOCAL_CUSTOM2"
            else
              echo "No local custom patches found"
            fi
          fi

          # Build series file: net -> cpu-scheduler -> custom -> remaining
          cd patches
          rm -f series
          echo "# Net Patches from Xanmod" >> series
          if [ -d net ]; then find net -type f -name '*.patch' | sort | sed 's|^\./||' | sed 's|^|&|' -u | awk -F/ '{print $0}' | sed 's|^|net/|' | sed 's| / /|/|' | sed -n '1,100p' >> series; fi
          echo "# CPU Scheduler Patches" >> series
          if [ -d cpu-scheduler ]; then find cpu-scheduler -type f -name '*.patch' | sort >> series; fi
          echo "# Custom Patches" >> series
          if [ -d custom ]; then find custom -type f -name '*.patch' | sort >> series; fi
          echo "# Other patches" >> series
          find . -maxdepth 1 -type f -name '*.patch' | sort >> series || true

          echo "===== series ====="
          sed -n '1,200p' series || true
          echo "✅ Patches organized"

      - name: Apply Patches (quilt)
        run: |
          set -e
          cd linux
          export QUILT_PATCHES=patches
          export QUILT_SERIES="patches/series"
          # show quilt status & series for debug
          echo "Quilt series:"
          sed -n '1,200p' patches/series || true
          quilt --quiltrc /dev/null series || true
          quilt push -a || { echo "Quilt apply failed — show top of patch stack"; quilt top || true; quilt files || true; exit 1; }
          echo "✅ All patches applied via quilt"


      # ---------------------------------------------------
      # Integrate LotSpeed (Zeta-TCP)
      # ---------------------------------------------------
      - name: Integrate LotSpeed (Zeta-TCP)
        run: |
          cd linux

          echo "=== Integrating LotSpeed ==="
          git clone -b zeta-tcp --depth=1 https://github.com/uk0/lotspeed.git ../lotspeed

          cp ../lotspeed/lotspeed.c net/ipv4/tcp_lotspeed.c
          echo "obj-\$(CONFIG_TCP_CONG_LOTSPEED) += tcp_lotspeed.o" >> net/ipv4/Makefile

          cat >> net/ipv4/Kconfig <<'EOF'

          config TCP_CONG_LOTSPEED
              tristate "LotSpeed Zeta-TCP congestion control"
              default y
              help
                Experimental congestion control algorithm for high-latency networks.
          EOF

      # ---------------------------------------------------
      # Configure Kernel
      # ---------------------------------------------------
      - name: Configure Kernel
        run: |
          cd linux

          if [ -f "../configs/x86_64.config" ]; then
            cp ../configs/x86_64.config .config
          else
            make defconfig
          fi

          echo "=== Enabling BORE Scheduler ==="
          scripts/config --enable CONFIG_SCHED_CLASS_EXT
          scripts/config --enable CONFIG_SCHED_BORE

          echo "=== Enable Congestion Control ==="
          scripts/config --set-val CONFIG_TCP_CONG_ADVANCED y
          scripts/config --set-val CONFIG_TCP_CONG_BBR y
          scripts/config --set-val CONFIG_TCP_CONG_BBR1 y 2>/dev/null || true
          scripts/config --set-val CONFIG_TCP_CONG_BBRPLUS y 2>/dev/null || true
          scripts/config --set-val CONFIG_TCP_CONG_BRUTAL y 2>/dev/null || true
          scripts/config --set-val CONFIG_TCP_CONG_LOTSPEED y

          scripts/config --set-val CONFIG_TCP_CONG_CUBIC y
          scripts/config --set-val CONFIG_TCP_CONG_RENO y
          scripts/config --set-val CONFIG_TCP_CONG_HTCP y
          scripts/config --set-val CONFIG_TCP_CONG_WESTWOOD y
          scripts/config --set-val CONFIG_TCP_CONG_VEGAS y

          scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
          scripts/config --enable CONFIG_DEFAULT_BBR
          scripts/config --disable CONFIG_DEFAULT_CUBIC

          echo "=== Disable BTF ==="
          scripts/config --disable CONFIG_DEBUG_INFO_BTF
          scripts/config --disable CONFIG_DEBUG_INFO_BTF_MODULES
          scripts/config --disable CONFIG_DEBUG_INFO

          scripts/config --disable CONFIG_INFINIBAND
          scripts/config --disable CONFIG_RDMA


          make olddefconfig

      # ---------------------------------------------------
      # Build Kernel
      # ---------------------------------------------------
      - name: Build Kernel Debian Packages
        env:
          KBUILD_BUILD_USER: "github"
          KBUILD_BUILD_HOST: "actions"
          KDEB_COMPRESS: "xz"
        run: |
          cd linux
          make -j$(nproc) bindeb-pkg

      # ---------------------------------------------------
      # Upload Artifacts
      # ---------------------------------------------------
      - name: Upload Kernel .deb Files
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ needs.prepare.outputs.KERNEL_VERSION }}
          path: |
            *.deb
            *.buildinfo
            *.changes
            linux/.config

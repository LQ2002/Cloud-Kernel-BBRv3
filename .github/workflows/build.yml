name: Build Debian Kernel (x86_64)

on:
  repository_dispatch:
    types: [trigger-x86_64-build]
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "Kernel version"
        required: true
        default: "6.12.37"
        type: string
      skip_cache:
        description: "Skip Cache"
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    name: Prepare Build Parameters
    runs-on: ubuntu-24.04
    outputs:
      kernel_version: ${{ steps.prepare_build_parameters.outputs.KERNEL_VERSION }}
      kernel_minor_version: ${{ steps.prepare_build_parameters.outputs.KERNEL_MINOR_VERSION }}
      kernel_major_version: ${{ steps.prepare_build_parameters.outputs.KERNEL_MAJOR_VERSION }}
      skip_cache: ${{ steps.prepare_build_parameters.outputs.SKIP_CACHE }}
    steps:
      - name: Prepare Build Parameters
        id: prepare_build_parameters
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            KERNEL_VERSION="${{ github.event.client_payload.kernel_version }}"
          else
            KERNEL_VERSION="${{ inputs.kernel_version }}"
          fi
          KERNEL_MINOR_VERSION=$(echo "$KERNEL_VERSION" | cut -d '.' -f 2)
          KERNEL_MAJOR_VERSION=$(echo "$KERNEL_VERSION" | cut -d '.' -f 1)
          SKIP_CACHE="${{ inputs.skip_cache }}" || SKIP_CACHE=false

          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          echo "KERNEL_MINOR_VERSION=$KERNEL_MINOR_VERSION" >> $GITHUB_OUTPUT
          echo "KERNEL_MAJOR_VERSION=$KERNEL_MAJOR_VERSION" >> $GITHUB_OUTPUT
          echo "SKIP_CACHE=$SKIP_CACHE" >> $GITHUB_OUTPUT

  build:
    name: Build Debian Kernel Package for x86_64
    runs-on: ubuntu-24.04
    needs: prepare
    outputs:
      kernel_version: ${{ needs.prepare.outputs.kernel_version }}
      build_time: ${{ steps.get_build_time.outputs.BUILD_TIMESTAMP }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl git patch jq openssl quilt \
            libncurses-dev libssl-dev libelf-dev libudev-dev libpci-dev libcap-dev libpcre2-dev libcurl4-openssl-dev \
            bison bc flex rsync debhelper lz4 pahole zstd dpkg-dev fakeroot kmod cpio xz-utils ccache

      - name: Checkout Kernel Sources
        uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Download Linux Kernel Source
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ needs.prepare.outputs.kernel_version }}.tar.xz
          tar -xf linux-${{ needs.prepare.outputs.kernel_version }}.tar.xz
          rm linux-${{ needs.prepare.outputs.kernel_version }}.tar.xz
          mv linux-${{ needs.prepare.outputs.kernel_version }} linux

      - name: Download Debian Kernel Patches
        run: |
          git clone -b debian/${{ needs.prepare.outputs.kernel_version }}-1 --depth=1 https://salsa.debian.org/kernel-team/linux.git linux-debian

      - name: Download Xanmod Network Patches (BBR/BBRv3)
        run: |
          git clone --depth=1 https://gitlab.com/xanmod/linux-patches.git linux-xanmod-patches

      - name: Checkout Bore Scheduler Patches
        uses: actions/checkout@v4
        with:
          repository: firelzrd/bore-scheduler
          path: bore-patches

      - name: Organize Patches
        run: |
          cd linux
          cp -R ../linux-debian/debian/patches ./patches
          cp -R ../linux-xanmod-patches/linux-${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}.y-xanmod/net ./patches/net
          cp -R ../bore-patches/patches/stable/linux-${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}-bore ./patches/cpu-scheduler
          mkdir -p patches/custom
          cp -R ../kernel_patches/${{ needs.prepare.outputs.kernel_major_version }}.${{ needs.prepare.outputs.kernel_minor_version }}/* patches/custom/
          
          cd patches
          echo "# Net Patches from Xanmod" >> series
          find ./net -type f -name "*.patch" -printf "net/%P\n" | sort >> series
          echo "# CPU Scheduler Patches from Bore" >> series
          find ./cpu-scheduler -type f -name "*.patch" -printf "cpu-scheduler/%P\n" | sort >> series
          echo "# Custom Patches" >> series
          find ./custom -type f -name "*.patch" -printf "custom/%P\n" | sort >> series

      - name: Apply Patches
        run: |
          cd linux
          quilt push -a

      - name: Configure Kernel
        run: |
          cd linux
          cp ../configs/x86_64.config .config
          
          echo "=== Configuring TCP Congestion Control ==="
          
          # 将所有 BBR 变体设置为内建 (built-in)
          scripts/config --enable CONFIG_TCP_CONG_BBR
          scripts/config --enable CONFIG_TCP_CONG_BBR1
          scripts/config --enable CONFIG_TCP_CONG_BBRPLUS
          scripts/config --enable CONFIG_TCP_CONG_BRUTAL
          
          # 设置 BBR 为默认拥塞控制算法
          scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
          scripts/config --enable CONFIG_DEFAULT_BBR
          scripts/config --disable CONFIG_DEFAULT_CUBIC
          
          # 重新生成配置，处理依赖关系
          make olddefconfig
          
          echo "=== TCP Congestion Control Configuration Complete ==="

      - name: Verify Kernel Configuration
        run: |
          cd linux
          
          echo "================================================"
          echo "Verifying TCP Congestion Control Configuration"
          echo "================================================"
          
          # 检查 BBR 变体是否都设置为内建
          echo ""
          echo "Checking BBR variants (should all be =y):"
          grep "CONFIG_TCP_CONG_BBR=" .config | grep -v "^#" || echo "❌ CONFIG_TCP_CONG_BBR not found or disabled"
          grep "CONFIG_TCP_CONG_BBR1=" .config | grep -v "^#" || echo "❌ CONFIG_TCP_CONG_BBR1 not found or disabled"
          grep "CONFIG_TCP_CONG_BBRPLUS=" .config | grep -v "^#" || echo "❌ CONFIG_TCP_CONG_BBRPLUS not found or disabled"
          grep "CONFIG_TCP_CONG_BRUTAL=" .config | grep -v "^#" || echo "❌ CONFIG_TCP_CONG_BRUTAL not found or disabled"
          
          # 检查默认拥塞控制算法
          echo ""
          echo "Checking default congestion control:"
          grep "CONFIG_DEFAULT_TCP_CONG=" .config | grep -v "^#" || echo "❌ CONFIG_DEFAULT_TCP_CONG not found"
          grep "CONFIG_DEFAULT_BBR=" .config | grep -v "^#" || echo "❌ CONFIG_DEFAULT_BBR not found"
          
          # 验证关键配置
          echo ""
          echo "Validation Results:"
          
          if grep -q "CONFIG_TCP_CONG_BBR=y" .config; then
            echo "✅ BBR is built-in"
          else
            echo "❌ BBR is NOT built-in"
            exit 1
          fi
          
          if grep -q "CONFIG_TCP_CONG_BBR1=y" .config; then
            echo "✅ BBR1 is built-in"
          else
            echo "⚠️  BBR1 is NOT built-in (might not exist in patches)"
          fi
          
          if grep -q "CONFIG_TCP_CONG_BBRPLUS=y" .config; then
            echo "✅ BBRPlus is built-in"
          else
            echo "⚠️  BBRPlus is NOT built-in (might not exist in patches)"
          fi
          
          if grep -q "CONFIG_TCP_CONG_BRUTAL=y" .config; then
            echo "✅ Brutal is built-in"
          else
            echo "⚠️  Brutal is NOT built-in (might not exist in patches)"
          fi
          
          if grep -q 'CONFIG_DEFAULT_TCP_CONG="bbr"' .config; then
            echo "✅ BBR is set as default"
          else
            echo "❌ BBR is NOT set as default"
            exit 1
          fi
          
          echo ""
          echo "================================================"
          echo "Configuration verification complete"
          echo "================================================"

      - name: Build Kernel Debian Packages
        env:
          KBUILD_BUILD_USER: "cloudpassenger"
          KBUILD_BUILD_HOST: "github-actions"
          KDEB_COMPRESS: "xz"
        run: |
          cd linux
          make -j $(nproc) bindeb-pkg

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-x86_64
          path: |
            *.deb
            *.changes
            *.buildinfo
            *.config

      - name: Get build time
        id: get_build_time
        run: |
          BUILD_TIMESTAMP=$(date -Is)
          echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT
```

## 主要修改说明

### 1. **Configure Kernel 步骤**（新增配置逻辑）
- 使用 `scripts/config` 工具强制启用所有 BBR 变体为内建 (`=y`)
- 设置 BBR 为默认拥塞控制算法
- 禁用 CUBIC 作为默认算法
- 运行 `make olddefconfig` 处理依赖关系

### 2. **Verify Kernel Configuration 步骤**（新增验证步骤）
- 检查所有 BBR 变体的配置状态
- 验证默认拥塞控制算法设置
- 如果关键配置缺失则构建失败
- 提供清晰的状态反馈（✅ 成功，⚠️ 警告，❌ 错误）

## 预期结果

构建完成后，您会在日志中看到类似输出：
```
================================================
Verifying TCP Congestion Control Configuration
================================================

Checking BBR variants (should all be =y):
CONFIG_TCP_CONG_BBR=y
CONFIG_TCP_CONG_BBR1=y
CONFIG_TCP_CONG_BBRPLUS=y
CONFIG_TCP_CONG_BRUTAL=y

Checking default congestion control:
CONFIG_DEFAULT_TCP_CONG="bbr"
CONFIG_DEFAULT_BBR=y

Validation Results:
✅ BBR is built-in
✅ BBR1 is built-in
✅ BBRPlus is built-in
✅ Brutal is built-in
✅ BBR is set as default

================================================
Configuration verification complete
================================================

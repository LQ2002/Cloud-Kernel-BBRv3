name: Build Linux Kernel with Zeta-TCP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    steps:
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses-dev bison flex \
          libssl-dev libelf-dev libdw-dev bc wget xz-utils git
    
    - name: 下载源码
      run: |
        # 下载内核
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.12.21.tar.xz
        tar -xf linux-6.12.21.tar.xz
        
        # 下载 zeta-tcp
        git clone -b zeta-tcp --depth=1 https://github.com/uk0/lotspeed.git
    
    - name: 集成并编译
      run: |
        cd linux-6.12.21
        
        # 集成 zeta-tcp
        mkdir -p net/ipv4/tcp_zeta
        cp ../lotspeed/zeta_tcp/*.c net/ipv4/tcp_zeta/
        cp ../lotspeed/zeta_tcp/*.h net/ipv4/tcp_zeta/
        
        # 创建 Makefile
        cat > net/ipv4/tcp_zeta/Makefile <<'MAKEFILE_EOF'
        obj-$(CONFIG_TCP_CONG_ZETA) += tcp_zeta.o
        tcp_zeta-y := zeta_main.o zeta_cong.o zeta_rtt.o zeta_loss.o
        MAKEFILE_EOF
        
        echo "obj-\$(CONFIG_TCP_CONG_ZETA) += tcp_zeta/" >> net/ipv4/Makefile
        
        # 添加 Kconfig
        cat >> net/ipv4/Kconfig <<'KCONFIG_EOF'
        
        config TCP_CONG_ZETA
        	tristate "Zeta TCP congestion control"
        	default m
        	help
        	  Zeta-TCP congestion control algorithm.
        KCONFIG_EOF
        
        # 配置内核
        make defconfig
        scripts/config --module CONFIG_TCP_CONG_ZETA
        scripts/config --disable CONFIG_DEBUG_INFO
        make olddefconfig
        
        # 编译模块
        make -j$(nproc) modules_prepare
        make -j$(nproc) M=net/ipv4/tcp_zeta modules
        
        # 检查结果
        ls -lh net/ipv4/tcp_zeta/tcp_zeta.ko
    
    - name: 上传到 Actions
      uses: actions/upload-artifact@v4
      with:
        name: zeta-tcp-kernel-6.12.21
        path: linux-6.12.21/net/ipv4/tcp_zeta/tcp_zeta.ko
        retention-days: 30
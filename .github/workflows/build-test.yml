name: Build Kernel with ZETA-TCP

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential flex bison libssl-dev \
          libncurses-dev dwarves bc git wget xz-utils

    - name: Download Linux kernel 6.12.21
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.12.21.tar.xz
        tar -xf linux-6.12.21.tar.xz
        mv linux-6.12.21 linux

    - name: Clone ZETA-TCP repo
      run: |
        git clone --branch zeta-tcp https://github.com/uk0/lotspeed.git lotspeed

    - name: Integrate ZETA-TCP as kernel module
      run: |
        mkdir -p linux/net/ipv4/zeta_tcp
        cp -r lotspeed/zeta_tcp/* linux/net/ipv4/zeta_tcp/

        # 将模块加入内核 build system
        echo "obj-m += zeta_tcp.o" > linux/net/ipv4/zeta_tcp/Makefile

        # 如果需要合并多个源文件为单个模块：
        # echo "zeta_tcp-objs := zeta_main.o zeta_cong.o zeta_loss.o zeta_rtt.o" >> linux/net/ipv4/zeta_tcp/Makefile

    - name: Prepare kernel config
      run: |
        cd linux
        make defconfig
        # 若希望模块自动构建，可开启 module support 以及 EXPORT options
        scripts/config --file .config -e MODULES
        make olddefconfig

    - name: Build kernel and modules
      run: |
        cd linux
        make -j"$(nproc)"

    - name: Build ZETA-TCP module
      run: |
        cd linux
        make M=net/ipv4/zeta_tcp -j"$(nproc)"

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zeta-tcp-kernel-build
        path: |
          linux/arch/*/boot/
          linux/net/ipv4/zeta_tcp/*.ko
          linux/.config

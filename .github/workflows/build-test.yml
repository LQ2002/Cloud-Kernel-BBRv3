name: Build Linux Kernel 6.12.21 with Zeta-TCP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    steps:
    - name: 清理磁盘空间
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
    
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses-dev bison flex \
          libssl-dev libelf-dev libdw-dev bc wget xz-utils git dwarves
    
    - name: 下载源码
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.12.21.tar.xz
        tar -xf linux-6.12.21.tar.xz
        git clone -b zeta-tcp --depth=1 https://github.com/uk0/lotspeed.git
    
    - name: 集成 Zeta-TCP
      run: |
        cd linux-6.12.21
        mkdir -p net/ipv4/tcp_zeta
        cp ../lotspeed/zeta_tcp/*.c net/ipv4/tcp_zeta/
        cp ../lotspeed/zeta_tcp/*.h net/ipv4/tcp_zeta/
        
        # 修复头文件
        sed -i '1i #include <linux/types.h>' net/ipv4/tcp_zeta/zeta_tcp.h
        sed -i '2i #include <net/tcp.h>' net/ipv4/tcp_zeta/zeta_tcp.h
        sed -i '3i #include <linux/tcp.h>' net/ipv4/tcp_zeta/zeta_tcp.h
        
        # 创建 Makefile
        cat > net/ipv4/tcp_zeta/Makefile <<'MAKEFILE_END'
        obj-m += tcp_zeta.o
        tcp_zeta-y := zeta_main.o zeta_cong.o zeta_rtt.o zeta_loss.o
        MAKEFILE_END
        
        echo 'obj-$(CONFIG_TCP_CONG_ZETA) += tcp_zeta/' >> net/ipv4/Makefile
        
        # 添加 Kconfig
        cat >> net/ipv4/Kconfig <<'KCONFIG_END'
        
        config TCP_CONG_ZETA
        	tristate "Zeta TCP congestion control"
        	default y
        	help
        	  Zeta-TCP congestion control algorithm.
        KCONFIG_END
    
    - name: 配置内核
      run: |
        cd linux-6.12.21
        make defconfig
        scripts/config --enable CONFIG_TCP_CONG_ZETA
        scripts/config --disable CONFIG_DEBUG_INFO
        scripts/config --disable CONFIG_DEBUG_INFO_BTF
        scripts/config --disable CONFIG_DEBUG_INFO_DWARF4
        scripts/config --disable CONFIG_DEBUG_INFO_DWARF5
        scripts/config --disable CONFIG_GDB_SCRIPTS
        make olddefconfig
    
    - name: 编译内核
      run: |
        cd linux-6.12.21
        make -j$(nproc) bzImage
        make -j$(nproc) modules
    
    - name: 打包产物
      run: |
        mkdir -p artifacts
        cp linux-6.12.21/arch/x86/boot/bzImage artifacts/
        find linux-6.12.21 -name "tcp_zeta.ko" -exec cp {} artifacts/ \;
        ls -lh artifacts/
    
    - name: 上传内核镜像
      uses: actions/upload-artifact@v4
      with:
        name: kernel-6.12.21-zeta-tcp
        path: artifacts/bzImage
        retention-days: 30
    
    - name: 上传模块
      uses: actions/upload-artifact@v4
      with:
        name: tcp_zeta-module
        path: artifacts/tcp_zeta.ko
        retention-days: 30

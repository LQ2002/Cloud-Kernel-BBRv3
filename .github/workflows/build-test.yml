name: Build Linux 6.12.37 with custom patches

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt-get install -y build-essential curl git patch jq openssl quilt \
            libncurses-dev libssl-dev libelf-dev libudev-dev libpci-dev libcap-dev libpcre2-dev libcurl4-openssl-dev \
            bison bc flex rsync debhelper lz4 pahole zstd dpkg-dev fakeroot kmod cpio xz-utils ccache \
            libdw-dev binutils-dev libunwind-dev libslang2-dev python3-dev python3-setuptools \
            liblzma-dev libzstd-dev libbabeltrace-dev libbfd-dev libiberty-dev libnuma-dev perl \
            dwarves wget

    - name: Checkout Kernel Sources
      uses: actions/checkout@v4
      with:
        fetch-tags: true

    - name: Download Linux 6.12.37
      run: |
        wget https://www.kernel.org/pub/linux/kernel/v6.x/linux-6.12.37.tar.xz
        tar xf linux-6.12.37.tar.xz
        mv linux-6.12.37 linux

    - name: Download and Check Patches
      run: |
        echo "=== Downloading patches for kernel linux-6.12.37 ==="
        echo ""
        
        # Debian è¡¥ä¸
        echo "Downloading Debian kernel patches..."
        if git clone -b debian/6.12.37-1 --depth=1 https://salsa.debian.org/kernel-team/linux.git linux-debian 2>&1; then
          echo "âœ… Debian patches downloaded successfully"
          echo "DEBIAN_OK=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ Debian patches not available (this is normal for newer kernels)"
          echo "DEBIAN_OK=false" >> $GITHUB_ENV
        fi
        
        echo ""
        
        # Xanmod è¡¥ä¸
        echo "Downloading Xanmod network patches..."
        if git clone --depth=1 https://gitlab.com/xanmod/linux-patches.git linux-xanmod-patches 2>&1; then
          XANMOD_DIR="linux-xanmod-patches/linux-6.12.y-xanmod"
          if [ -d "$XANMOD_DIR" ]; then
            echo "âœ… Xanmod patches downloaded successfully"
            echo "XANMOD_OK=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ Xanmod patches not available for kernel 6.12"
            echo "Available versions:"
            ls linux-xanmod-patches/ | grep "linux-" | sort -V
            echo "XANMOD_OK=false" >> $GITHUB_ENV
          fi
        else
          echo "âŒ Failed to download Xanmod patches repository"
          echo "XANMOD_OK=false" >> $GITHUB_ENV
        fi
        
        echo ""
        
        # Bore è¡¥ä¸
        echo "Downloading Bore scheduler patches..."
        if git clone --depth=1 https://github.com/firelzrd/bore-scheduler.git bore-patches 2>&1; then
          BORE_DIR="bore-patches/patches/stable/linux-6.12-bore"
          if [ -d "$BORE_DIR" ]; then
            echo "âœ… Bore patches downloaded successfully"
            echo "BORE_OK=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ Bore patches not available for kernel 6.12"
            echo "Available versions:"
            ls bore-patches/patches/stable/ | grep "linux-" | sort -V
            echo "BORE_OK=false" >> $GITHUB_ENV
          fi
        else
          echo "âŒ Failed to download Bore patches repository"
          echo "BORE_OK=false" >> $GITHUB_ENV
        fi
        
        echo ""
        echo "=== Patch download summary ==="
        echo "Debian: $DEBIAN_OK"
        echo "Xanmod: $XANMOD_OK"
        echo "Bore: $BORE_OK"

    - name: Organize Patches
      run: |
        cd linux
        mkdir -p patches
        
        echo "=== Step 1: Copy Debian patches ==="
        if [ "$DEBIAN_OK" == "true" ] && [ -d "../linux-debian/debian/patches" ]; then
          cp -R ../linux-debian/debian/patches/* ./patches/
          echo "âœ… Debian patches copied"
        else
          touch patches/series
          echo "âš ï¸ Debian patches not available, creating empty series"
        fi
        
        echo ""
        echo "=== Step 2: Copy Xanmod patches ==="
        if [ "$XANMOD_OK" == "true" ]; then
          XANMOD_SOURCE="../linux-xanmod-patches/linux-6.12.y-xanmod"
          
          if [ -d "$XANMOD_SOURCE/net" ]; then
            mkdir -p patches/xanmod-net
            cp -R "$XANMOD_SOURCE/net"/* patches/xanmod-net/
            
            XANMOD_COUNT=$(find patches/xanmod-net -type f -name "*.patch" | wc -l)
            echo "âœ… Copied $XANMOD_COUNT Xanmod patches"
          else
            echo "âš ï¸ Xanmod net directory not found"
          fi
        else
          echo "âš ï¸ Xanmod patches not available, skipping"
        fi
        
        echo ""
        echo "=== Step 3: Copy Bore patches ==="
        if [ "$BORE_OK" == "true" ]; then
          BORE_SOURCE="../bore-patches/patches/stable/linux-6.12-bore"
          
          if [ -d "$BORE_SOURCE" ]; then
            cp -R "$BORE_SOURCE" patches/cpu-scheduler
            
            BORE_COUNT=$(find patches/cpu-scheduler -type f -name "*.patch" | wc -l)
            echo "âœ… Copied $BORE_COUNT Bore patches"
          else
            echo "âš ï¸ Bore directory not found"
          fi
        else
          echo "âš ï¸ Bore patches not available, skipping"
        fi
        
        echo ""
        echo "=== Step 4: Copy custom patches ==="
        CUSTOM_SOURCE="../kernel_patches/6.12"
        
        echo "Looking for custom patches in: $CUSTOM_SOURCE"
        
        if [ -d "$CUSTOM_SOURCE" ]; then
          echo "âœ… Custom patch directory found"
          
          mkdir -p patches/custom
          cp -R "$CUSTOM_SOURCE"/* patches/custom/
          
          echo "Copied custom patches:"
          find patches/custom -type f -name "*.patch" | while read f; do
            echo "  - $f"
          done
          
          CUSTOM_COUNT=$(find patches/custom -type f -name "*.patch" | wc -l)
          echo "âœ… Total custom patches: $CUSTOM_COUNT"
        else
          echo "âš ï¸ Custom patch directory not found: $CUSTOM_SOURCE"
        fi
        
        echo ""
        echo "=== Step 5: Build series file ==="
        cd patches
        
        if [ "$DEBIAN_OK" != "true" ]; then
          echo "# Patch series for kernel 6.12" > series
          echo "# Generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> series
        fi
        
        if [ -d "./xanmod-net" ]; then
          XANMOD_PATCH_COUNT=$(find ./xanmod-net -type f -name "*.patch" | wc -l)
          if [ $XANMOD_PATCH_COUNT -gt 0 ]; then
            echo "" >> series
            echo "# Xanmod Network Patches ($XANMOD_PATCH_COUNT patches)" >> series
            find ./xanmod-net -type f -name "*.patch" -printf "xanmod-net/%P\n" | sort >> series
            echo "Added $XANMOD_PATCH_COUNT Xanmod patches to series"
          fi
        fi
        
        if [ -d "./cpu-scheduler" ]; then
          BORE_PATCH_COUNT=$(find ./cpu-scheduler -type f -name "*.patch" | wc -l)
          if [ $BORE_PATCH_COUNT -gt 0 ]; then
            echo "" >> series
            echo "# Bore CPU Scheduler Patches ($BORE_PATCH_COUNT patches)" >> series
            find ./cpu-scheduler -type f -name "*.patch" -printf "cpu-scheduler/%P\n" | sort >> series
            echo "Added $BORE_PATCH_COUNT Bore patches to series"
          fi
        fi
        
        if [ -d "./custom" ]; then
          CUSTOM_PATCH_COUNT=$(find ./custom -type f -name "*.patch" | wc -l)
          
          if [ $CUSTOM_PATCH_COUNT -gt 0 ]; then
            echo "" >> series
            echo "# Custom Patches ($CUSTOM_PATCH_COUNT patches)" >> series
            find ./custom -type f -name "*.patch" -printf "custom/%P\n" | sort >> series
            
            echo "âœ… Added $CUSTOM_PATCH_COUNT custom patches to series"
            
            echo ""
            echo "Custom patches in series:"
            grep "^custom/" series | nl
          fi
        fi
        
        echo ""
        echo "=== Final series file content ==="
        cat series
        echo "=================================="
        
        echo ""
        echo "=== Statistics ==="
        TOTAL_PATCHES=$(grep -c "\.patch$" series || echo 0)
        XANMOD_IN_SERIES=$(grep -c "^xanmod-net/" series || echo 0)
        BORE_IN_SERIES=$(grep -c "^cpu-scheduler/" series || echo 0)
        CUSTOM_IN_SERIES=$(grep -c "^custom/" series || echo 0)
        
        echo "Total patches in series: $TOTAL_PATCHES"
        echo "  - Xanmod: $XANMOD_IN_SERIES"
        echo "  - Bore: $BORE_IN_SERIES"
        echo "  - Custom: $CUSTOM_IN_SERIES"
        echo "=================="
    - name: Apply Patches
      run: |
        cd linux
        
        if [ ! -s patches/series ]; then
          echo "âš ï¸ No patches to apply"
          exit 0
        fi
        
        echo "=== Applying Patches ==="
        quilt push -a -v || echo "Some patches may have failed"
        
        echo ""
        echo "=== Patch Summary ==="
        
        TOTAL_EXPECTED=$(grep -c "\.patch$" patches/series || echo 0)
        TOTAL_APPLIED=$(quilt applied 2>/dev/null | wc -l || echo 0)
        
        echo "Total: $TOTAL_APPLIED / $TOTAL_EXPECTED applied"
        
        CUSTOM_EXPECTED=$(grep -c "^custom/" patches/series || echo 0)
        
        if [ $CUSTOM_EXPECTED -gt 0 ]; then
          CUSTOM_APPLIED=$(quilt applied 2>/dev/null | grep -c "^custom/" || echo 0)
          
          echo "Custom patches: $CUSTOM_APPLIED / $CUSTOM_EXPECTED"
          
          if [ $CUSTOM_APPLIED -gt 0 ]; then
            echo "âœ… Custom patches applied:"
            quilt applied | grep "^custom/"
          fi
        fi
        
        echo ""
        echo "Final patch: $(quilt top)"

    - name: Add LotSpeed source file
      run: |
        # 1. ä¸‹è½½æºç 
        wget https://raw.githubusercontent.com/uk0/lotspeed/zeta-tcp/lotspeed.c \
          -O linux/net/ipv4/tcp_lotspeed.c
        
        # 2. ã€ä¿®å¤é”™è¯¯ 1ã€‘ä¿®æ”¹ SAFE_DIV64 å®å®šä¹‰
        # åŸä»£ç : #define SAFE_DIV64(n, d) ((d) ? div64_u64(n, d) : 0)
        # é—®é¢˜: (d) å¦‚æœæ˜¯ä¸€ä¸ªè®¡ç®—è¡¨è¾¾å¼ï¼ŒGCC ä¼šæŠ¥ int-in-bool-context è­¦å‘Š
        # ä¿®å¤: æ”¹ä¸º ((d) != 0 ? ...) æ˜¾å¼åˆ¤æ–­
        sed -i 's/#define SAFE_DIV64(n, d) ((d) ? div64_u64(n, d) : 0)/#define SAFE_DIV64(n, d) ((d) != 0 ? div64_u64(n, d) : 0)/' linux/net/ipv4/tcp_lotspeed.c

        # 3. ã€ä¿®å¤é”™è¯¯ 2ã€‘æ³¨é‡Šæ‰æœªä½¿ç”¨çš„å˜é‡ total_bytes_sent
        # é”™è¯¯: defined but not used [-Werror=unused-variable]
        sed -i 's/static atomic64_t total_bytes_sent/\/\/ static atomic64_t total_bytes_sent/' linux/net/ipv4/tcp_lotspeed.c

    - name: Configure Kconfig and Makefile for LotSpeed
      run: |
        cd linux
        
        # --- ä¿®æ”¹ Kconfig ---
        if grep -q "config TCP_CONG_LOTSPEED" net/ipv4/Kconfig; then
          echo "LotSpeed config already exists, skipping modification."
        else
          cat >> net/ipv4/Kconfig << 'EOF'
        
        config TCP_CONG_LOTSPEED
        	tristate "LotSpeed TCP congestion control"
        	depends on TCP_CONG_ADVANCED
        	default n
        	help
        	  LotSpeed TCP congestion control algorithm.
        EOF
        fi
        
        # --- ä¿®æ”¹ Makefile ---
        if ! grep -q "tcp_lotspeed.o" net/ipv4/Makefile; then
          echo 'obj-$(CONFIG_TCP_CONG_LOTSPEED) += tcp_lotspeed.o' >> net/ipv4/Makefile
        fi
        
        # --- éªŒè¯ ---
        echo "=== Kconfig éªŒè¯ ==="
        grep -A 6 "config TCP_CONG_LOTSPEED" net/ipv4/Kconfig
        echo ""
        echo "=== Makefile éªŒè¯ ==="
        grep "tcp_lotspeed.o" net/ipv4/Makefile

    - name: Configure kernel
      working-directory: linux
      run: |
        cp ../configs/x86_64.config .config

        echo "=== Configuring TCP Congestion Control ==="
        
        if [ "$XANMOD_OK" == "true" ]; then
          # å¯ç”¨æ‰€æœ‰ BBR å˜ä½“(å¦‚æœå­˜åœ¨)
          scripts/config --enable CONFIG_TCP_CONG_BBR
          scripts/config --enable CONFIG_TCP_CONG_BBR1 2>/dev/null || true
          scripts/config --enable CONFIG_TCP_CONG_BBR2 2>/dev/null || true
          scripts/config --enable CONFIG_TCP_CONG_BBRPLUS 2>/dev/null || true
          scripts/config --enable CONFIG_TCP_CONG_BRUTAL 2>/dev/null || true
          
          echo "âœ… Configured BBR variants"
        fi
        
        # ğŸ”´ æ·»åŠ  BORE è°ƒåº¦å™¨é…ç½®
        if [ "$BORE_OK" == "true" ]; then
          echo ""
          echo "=== Configuring BORE Scheduler ==="
          scripts/config --enable CONFIG_SCHED_BORE
          scripts/config --set-val CONFIG_SCHED_BORE_DEFAULT 1
          echo "âœ… BORE scheduler enabled"
        fi
          
        echo ""
        echo "=== Disabling BTF ==="
        scripts/config --disable CONFIG_DEBUG_INFO_BTF
        scripts/config --disable CONFIG_DEBUG_INFO_BTF_MODULES
        scripts/config --disable CONFIG_DEBUG_INFO
        
        # å¼€å¯é«˜çº§æ‹¥å¡æ§åˆ¶é€‰é¡¹ï¼Œå¦åˆ™è‡ªå®šä¹‰ç®—æ³•å¯èƒ½ä¸æ˜¾ç¤º
        scripts/config --enable CONFIG_TCP_CONG_ADVANCED

        # å¼€å¯ LotSpeed æ¨¡å—
        scripts/config --enable CONFIG_TCP_CONG_ADVANCED
        scripts/config --enable CONFIG_TCP_CONG_LOTSPEED
        
        # æ›´æ–°é…ç½®
        make olddefconfig
        
        # æ£€æŸ¥æœ€ç»ˆé…ç½®æ˜¯å¦ç”Ÿæ•ˆ
        grep "CONFIG_TCP_CONG_LOTSPEED" .config

    - name: Build kernel
      working-directory: linux
      run: |
        # å¼€å§‹ç¼–è¯‘å¹¶æ‰“åŒ… (ä½¿ç”¨ -j$(nproc) åŠ é€Ÿ)
        # bindeb-pkg ä¼šè‡ªåŠ¨ç”Ÿæˆ headers, image, libc-dev ç­‰ deb åŒ…
        make -j$(nproc) bindeb-pkg

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-6.12.37-custom
        path: |
            *.deb
            *.changes
            *.buildinfo
            *.config
